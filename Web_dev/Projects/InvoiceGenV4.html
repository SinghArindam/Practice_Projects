<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Invoice Manager</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            max-width: 1000px; /* Increased max-width for dashboard */
            margin: auto;
        }
        h1, h2 {
            color: #0056b3;
            text-align: center;
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 25px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        .section:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"],
        input[type="number"],
        input[type="date"],
        textarea,
        select {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .row > div {
            flex: 1;
        }
        .item-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
        }
        .item-row input[type="text"],
        .item-row input[type="number"] {
            margin-bottom: 0;
            flex: 1;
        }
        .item-row .description {
            flex: 3;
        }
        .item-row .total-amount {
            flex: 1;
            text-align: right;
            font-weight: bold;
        }
        .add-item-btn, .remove-item-btn, .action-btn, .print-btn, .clear-btn, .download-pdf-btn, .new-invoice-btn, .back-to-dashboard-btn {
            background-color: #28a745;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            white-space: nowrap; /* Prevent wrapping on buttons */
        }
        .remove-item-btn {
            background-color: #dc3545;
            padding: 8px 12px;
            font-size: 14px;
        }
        .action-btn {
            background-color: #007bff;
        }
        .print-btn {
            background-color: #6c757d;
        }
        .download-pdf-btn {
            background-color: #dc3545;
        }
        .clear-btn {
            background-color: #ffc107;
            color: #333;
        }
        .new-invoice-btn, .back-to-dashboard-btn {
            background-color: #007bff;
            margin-bottom: 20px;
        }
        .add-item-btn:hover, .remove-item-btn:hover, .action-btn:hover, .print-btn:hover, .clear-btn:hover, .download-pdf-btn:hover, .new-invoice-btn:hover, .back-to-dashboard-btn:hover {
            opacity: 0.9;
        }
        .totals {
            text-align: right;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .totals div {
            margin-bottom: 8px;
        }
        .totals .grand-total {
            font-size: 1.2em;
            font-weight: bold;
            color: #0056b3;
        }

        /* Dashboard Styles */
        #dashboardView {
            display: block; /* Show by default */
        }
        #invoiceFormView {
            display: none; /* Hidden by default */
        }

        #invoiceDashboard {
            margin-top: 30px;
        }
        .invoice-card-header, .invoice-card-row {
            display: flex;
            padding: 10px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }
        .invoice-card-header {
            font-weight: bold;
            background-color: #f0f0f0;
            border-radius: 4px 4px 0 0;
        }
        .invoice-card-row:nth-child(even) {
            background-color: #f9f9f9;
        }
        .invoice-card-row:last-child {
            border-bottom: none;
        }
        .invoice-card-col {
            padding: 5px;
            flex: 1;
            overflow: hidden; /* Prevent text overflow */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
            white-space: nowrap; /* Keep text on single line */
        }
        .invoice-card-col.invoice-number { flex: 0.8; }
        .invoice-card-col.client-name { flex: 1.5; }
        .invoice-card-col.invoice-date { flex: 0.9; }
        .invoice-card-col.subtotal, .invoice-card-col.grand-total { flex: 0.9; text-align: right; }
        .invoice-card-col.status { flex: 0.8; }
        .invoice-card-col.actions { flex: 2; display: flex; gap: 5px; justify-content: flex-end;}
        .invoice-card-col.actions button {
            padding: 5px 8px;
            font-size: 12px;
            margin: 0;
        }
        .status-select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        #clientModal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-content button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
        }
        .modal-content button:hover {
            opacity: 0.9;
        }
        .client-selection-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .client-selection-group select {
            flex: 1;
            margin-bottom: 0;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #invoiceForm, #invoiceForm * {
                visibility: visible;
            }
            #invoiceForm {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                padding: 0;
            }
            .section, .row, .item-row {
                page-break-inside: avoid;
            }
            .add-item-btn, .remove-item-btn, .action-btn, .print-btn, .clear-btn, #invoiceList, #clientModal, .download-pdf-btn, .new-invoice-btn, .back-to-dashboard-btn {
                display: none;
            }
            input, textarea, select {
                border: none !important;
                padding: 0 !important;
            }
            .totals div {
                border-top: none;
                padding-top: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Construction Invoice Manager</h1>

        <div id="dashboardView">
            <button type="button" class="new-invoice-btn" onclick="showInvoiceForm()">Create New Invoice</button>
            <div class="section" id="invoiceDashboard">
                <h2>All Invoices</h2>
                <div class="invoice-list-container">
                    <div class="invoice-card-header">
                        <div class="invoice-card-col invoice-number">Invoice #</div>
                        <div class="invoice-card-col client-name">Client</div>
                        <div class="invoice-card-col invoice-date">Date</div>
                        <div class="invoice-card-col subtotal">Subtotal</div>
                        <div class="invoice-card-col grand-total">Grand Total</div>
                        <div class="invoice-card-col status">Status</div>
                        <div class="invoice-card-col actions">Actions</div>
                    </div>
                    <div id="invoicesDisplay">
                        </div>
                </div>
            </div>
        </div>

        <div id="invoiceFormView">
            <button type="button" class="back-to-dashboard-btn" onclick="showDashboard()">Back to Dashboard</button>

            <div class="section">
                <h2>Client Management</h2>
                <div class="client-selection-group">
                    <label for="clientSelect">Select Client:</label>
                    <select id="clientSelect">
                        <option value="">-- Select or Add New Client --</option>
                    </select>
                    <button type="button" class="add-item-btn" onclick="openClientModal()">Add New Client</button>
                </div>
                <div class="form-group">
                    <label for="billingTo">Billing To:</label>
                    <textarea id="billingTo" rows="4" placeholder="Client Name, Address Line 1, City, Postcode" readonly></textarea>
                </div>
                <div class="form-group">
                    <label for="siteAddress">Site Address:</label>
                    <textarea id="siteAddress" rows="4" placeholder="Site Name, Address Line 1, City, Postcode" readonly></textarea>
                </div>
            </div>

            <div class="section">
                <h2>Invoice Details</h2>
                <form id="invoiceForm">
                    <div class="row">
                        <div>
                            <label for="invoiceNumber">Invoice Number:</label>
                            <input type="text" id="invoiceNumber" required>
                        </div>
                        <div>
                            <label for="invoiceDate">Invoice Date:</label>
                            <input type="date" id="invoiceDate" required>
                        </div>
                        <div>
                            <label for="dueDate">Due Date:</label>
                            <input type="date" id="dueDate">
                        </div>
                    </div>

                    <h3>Line Items</h3>
                    <div id="lineItemsContainer">
                        <div class="item-row">
                            <input type="text" class="description" placeholder="Description of work/materials" oninput="calculateItemTotal(this.parentNode)">
                            <input type="number" class="quantity" value="1" min="1" oninput="calculateItemTotal(this.parentNode)">
                            <input type="number" class="unit-price" value="0.00" min="0" step="0.01" oninput="calculateItemTotal(this.parentNode)">
                            <span class="total-amount">0.00</span>
                            <button type="button" class="remove-item-btn" onclick="removeItem(this.parentNode)">Remove</button>
                        </div>
                    </div>
                    <button type="button" class="add-item-btn" onclick="addLineItem()">Add Line Item</button>

                    <div class="totals">
                        <div>Subtotal: $<span id="subtotal">0.00</span></div>
                        <div>
                            Tax Rate (%): <input type="number" id="taxRate" value="10" min="0" step="0.1" oninput="calculateGrandTotal()">
                            Tax Amount: $<span id="taxAmount">0.00</span>
                        </div>
                        <div class="grand-total">Grand Total: $<span id="grandTotal">0.00</span></div>
                    </div>

                    <div style="margin-top: 30px; text-align: center;">
                        <button type="button" class="action-btn" onclick="saveInvoice()">Save Invoice</button>
                        <button type="button" class="print-btn" onclick="window.print()">Print Current Invoice</button> <button type="button" class="download-pdf-btn" onclick="downloadPdf()">Download Current Invoice as PDF</button>
                        <button type="button" class="clear-btn" onclick="clearForm()">Clear Form</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="clientModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeClientModal()">&times;</span>
            <h2>Add New Client</h2>
            <div class="form-group">
                <label for="newClientName">Client Name:</label>
                <input type="text" id="newClientName" required>
            </div>
            <div class="form-group">
                <label for="newClientBillingAddress">Billing Address:</label>
                <textarea id="newClientBillingAddress" rows="4" placeholder="Client Name, Address Line 1, City, Postcode" required></textarea>
            </div>
            <div class="form-group">
                <label for="newClientSiteAddress">Site Address:</label>
                <textarea id="newClientSiteAddress" rows="4" placeholder="Site Name, Address Line 1, City, Postcode"></textarea>
            </div>
            <button type="button" onclick="addNewClient()">Save Client</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        const CLIENTS_STORAGE_KEY = 'construction_invoice_clients';
        const INVOICES_STORAGE_KEY = 'construction_invoice_invoices';
        const INVOICE_STATUSES = ['Draft', 'Sent', 'Paid', 'Overdue', 'Cancelled'];

        // --- View Management ---
        function showDashboard() {
            document.getElementById('dashboardView').style.display = 'block';
            document.getElementById('invoiceFormView').style.display = 'none';
            populateInvoicesDashboard(); // Refresh the list
        }

        function showInvoiceForm(invoiceNumber = null) {
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('invoiceFormView').style.display = 'block';
            if (invoiceNumber) {
                loadInvoice(invoiceNumber);
            } else {
                clearForm(); // Clear for new invoice
            }
        }

        // --- Client Management ---
        function getClients() {
            const clientsJson = localStorage.getItem(CLIENTS_STORAGE_KEY);
            return clientsJson ? JSON.parse(clientsJson) : [];
        }

        function saveClients(clients) {
            localStorage.setItem(CLIENTS_STORAGE_KEY, JSON.stringify(clients));
        }

        function populateClientSelect() {
            const clientSelect = document.getElementById('clientSelect');
            clientSelect.innerHTML = '<option value="">-- Select or Add New Client --</option>';
            const clients = getClients();
            clients.forEach((client, index) => {
                const option = document.createElement('option');
                option.value = index; // Use index as value to easily retrieve client object
                option.textContent = client.name;
                clientSelect.appendChild(option);
            });
        }

        function openClientModal() {
            document.getElementById('clientModal').style.display = 'block';
            document.getElementById('newClientName').value = '';
            document.getElementById('newClientBillingAddress').value = '';
            document.getElementById('newClientSiteAddress').value = '';
        }

        function closeClientModal() {
            document.getElementById('clientModal').style.display = 'none';
        }

        function addNewClient() {
            const name = document.getElementById('newClientName').value.trim();
            const billingAddress = document.getElementById('newClientBillingAddress').value.trim();
            const siteAddress = document.getElementById('newClientSiteAddress').value.trim();

            if (!name || !billingAddress) {
                alert('Client Name and Billing Address are required.');
                return;
            }

            const clients = getClients();
            clients.push({ name, billingAddress, siteAddress });
            saveClients(clients);
            populateClientSelect();
            closeClientModal();
            // Select the newly added client
            document.getElementById('clientSelect').value = clients.length - 1;
            loadClientDetails();
        }

        function loadClientDetails() {
            const clientSelect = document.getElementById('clientSelect');
            const selectedIndex = clientSelect.value;
            const billingTo = document.getElementById('billingTo');
            const siteAddress = document.getElementById('siteAddress');

            if (selectedIndex !== "") {
                const clients = getClients();
                const selectedClient = clients[selectedIndex];
                billingTo.value = selectedClient.billingAddress;
                siteAddress.value = selectedClient.siteAddress;
            } else {
                billingTo.value = '';
                siteAddress.value = '';
            }
        }

        // --- Invoice Creation ---
        function addLineItem(description = '', quantity = 1, unitPrice = 0) {
            const container = document.getElementById('lineItemsContainer');
            const itemRow = document.createElement('div');
            itemRow.classList.add('item-row');
            itemRow.innerHTML = `
                <input type="text" class="description" placeholder="Description of work/materials" value="${description}">
                <input type="number" class="quantity" value="${quantity}" min="1">
                <input type="number" class="unit-price" value="${unitPrice.toFixed(2)}" min="0" step="0.01">
                <span class="total-amount">${(quantity * unitPrice).toFixed(2)}</span>
                <button type="button" class="remove-item-btn" onclick="removeItem(this.parentNode)">Remove</button>
            `;
            // Add event listeners directly to the new inputs
            const quantityInput = itemRow.querySelector('.quantity');
            const unitPriceInput = itemRow.querySelector('.unit-price');
            quantityInput.addEventListener('input', () => calculateItemTotal(itemRow));
            unitPriceInput.addEventListener('input', () => calculateItemTotal(itemRow));
            itemRow.querySelector('.description').addEventListener('input', () => calculateItemTotal(itemRow)); // Recalculate on description change too, just in case

            container.appendChild(itemRow);
            calculateGrandTotal(); // Recalculate totals after adding an item
        }

        function removeItem(itemRow) {
            itemRow.remove();
            calculateGrandTotal(); // Recalculate totals after removing an item
        }

        function calculateItemTotal(itemRow) {
            const quantity = parseFloat(itemRow.querySelector('.quantity').value) || 0;
            const unitPrice = parseFloat(itemRow.querySelector('.unit-price').value) || 0;
            const totalAmountSpan = itemRow.querySelector('.total-amount');
            totalAmountSpan.textContent = (quantity * unitPrice).toFixed(2);
            calculateGrandTotal();
        }

        function calculateGrandTotal() {
            let subtotal = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                subtotal += parseFloat(row.querySelector('.total-amount').textContent) || 0;
            });
            document.getElementById('subtotal').textContent = subtotal.toFixed(2);

            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const taxAmount = subtotal * (taxRate / 100);
            document.getElementById('taxAmount').textContent = taxAmount.toFixed(2);

            const grandTotal = subtotal + taxAmount;
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
        }

        // --- Invoice Storage and Retrieval ---
        function getInvoices() {
            const invoicesJson = localStorage.getItem(INVOICES_STORAGE_KEY);
            return invoicesJson ? JSON.parse(invoicesJson) : [];
        }

        function saveInvoices(invoices) {
            localStorage.setItem(INVOICES_STORAGE_KEY, JSON.stringify(invoices));
        }

        function saveInvoice() {
            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
            const invoiceDate = document.getElementById('invoiceDate').value;
            const dueDate = document.getElementById('dueDate').value;
            const clientSelect = document.getElementById('clientSelect');
            const selectedClientIndex = clientSelect.value;
            const selectedClientName = selectedClientIndex !== "" ? clientSelect.options[clientSelect.selectedIndex].text : '';

            if (!invoiceNumber || !invoiceDate || selectedClientIndex === "") {
                alert('Invoice Number, Invoice Date, and Client are required.');
                return;
            }

            const lineItems = [];
            document.querySelectorAll('.item-row').forEach(row => {
                lineItems.push({
                    description: row.querySelector('.description').value.trim(),
                    quantity: parseFloat(row.querySelector('.quantity').value) || 0,
                    unitPrice: parseFloat(row.querySelector('.unit-price').value) || 0,
                    total: parseFloat(row.querySelector('.total-amount').textContent) || 0
                });
            });

            const currentInvoices = getInvoices();
            const existingInvoice = currentInvoices.find(inv => inv.invoiceNumber === invoiceNumber);

            let status = 'Draft'; // Default status for new invoices

            if (existingInvoice) {
                status = existingInvoice.status; // Preserve existing status on update
            }

            const invoice = {
                invoiceNumber: invoiceNumber,
                invoiceDate: invoiceDate,
                dueDate: dueDate,
                client: {
                    index: selectedClientIndex,
                    name: selectedClientName,
                    billingAddress: document.getElementById('billingTo').value,
                    siteAddress: document.getElementById('siteAddress').value
                },
                lineItems: lineItems,
                subtotal: parseFloat(document.getElementById('subtotal').textContent),
                taxRate: parseFloat(document.getElementById('taxRate').value),
                taxAmount: parseFloat(document.getElementById('taxAmount').textContent),
                grandTotal: parseFloat(document.getElementById('grandTotal').textContent),
                status: status, // Add status
                lastUpdated: new Date().toISOString()
            };


            if (existingInvoice) {
                const index = currentInvoices.indexOf(existingInvoice);
                currentInvoices[index] = invoice;
                alert('Invoice updated successfully!');
            } else {
                currentInvoices.push(invoice);
                alert('Invoice saved successfully!');
            }
            saveInvoices(currentInvoices);
            showDashboard(); // Go back to dashboard after saving
        }

        function populateInvoicesDashboard() {
            const invoicesDisplay = document.getElementById('invoicesDisplay');
            invoicesDisplay.innerHTML = '';
            const invoices = getInvoices();

            if (invoices.length === 0) {
                invoicesDisplay.innerHTML = '<div style="text-align: center; padding: 20px;">No invoices saved yet. Click "Create New Invoice" to get started.</div>';
                return;
            }

            invoices.sort((a, b) => new Date(b.invoiceDate) - new Date(a.invoiceDate)); // Sort by date descending

            invoices.forEach(invoice => {
                const invoiceRow = document.createElement('div');
                invoiceRow.classList.add('invoice-card-row');
                invoiceRow.innerHTML = `
                    <div class="invoice-card-col invoice-number">${invoice.invoiceNumber}</div>
                    <div class="invoice-card-col client-name">${invoice.client.name}</div>
                    <div class="invoice-card-col invoice-date">${invoice.invoiceDate}</div>
                    <div class="invoice-card-col subtotal">$${invoice.subtotal.toFixed(2)}</div>
                    <div class="invoice-card-col grand-total">$${invoice.grandTotal.toFixed(2)}</div>
                    <div class="invoice-card-col status">
                        <select class="status-select" onchange="updateInvoiceStatus('${invoice.invoiceNumber}', this.value)">
                            ${INVOICE_STATUSES.map(status => `<option value="${status}" ${invoice.status === status ? 'selected' : ''}>${status}</option>`).join('')}
                        </select>
                    </div>
                    <div class="invoice-card-col actions">
                        <button class="action-btn" onclick="showInvoiceForm('${invoice.invoiceNumber}')">View/Edit</button>
                        <button class="download-pdf-btn" onclick="downloadPdf('${invoice.invoiceNumber}')">PDF</button>
                        <button class="print-btn" onclick="printSpecificInvoice('${invoice.invoiceNumber}')">Print</button>
                        <button class="remove-item-btn" onclick="deleteInvoice('${invoice.invoiceNumber}')">Delete</button>
                    </div>
                `;
                invoicesDisplay.appendChild(invoiceRow);
            });
        }

        function updateInvoiceStatus(invoiceNumber, newStatus) {
            const invoices = getInvoices();
            const invoice = invoices.find(inv => inv.invoiceNumber === invoiceNumber);
            if (invoice) {
                invoice.status = newStatus;
                saveInvoices(invoices);
                populateInvoicesDashboard(); // Refresh to reflect change
                alert(`Invoice #${invoiceNumber} status updated to ${newStatus}`);
            }
        }

        function loadInvoice(invoiceNumber) {
            const invoices = getInvoices();
            const invoice = invoices.find(inv => inv.invoiceNumber === invoiceNumber);

            if (invoice) {
                document.getElementById('invoiceNumber').value = invoice.invoiceNumber;
                document.getElementById('invoiceDate').value = invoice.invoiceDate;
                document.getElementById('dueDate').value = invoice.dueDate;

                // Select the client
                document.getElementById('clientSelect').value = invoice.client.index;
                loadClientDetails(); // Re-populate billing and site addresses

                // Clear existing line items
                const lineItemsContainer = document.getElementById('lineItemsContainer');
                lineItemsContainer.innerHTML = '';

                // Add line items from saved invoice
                invoice.lineItems.forEach(item => {
                    addLineItem(item.description, item.quantity, item.unitPrice);
                });

                document.getElementById('taxRate').value = invoice.taxRate;
                calculateGrandTotal(); // Ensure totals are recalculated accurately
            } else {
                alert('Invoice not found.');
            }
        }

        function deleteInvoice(invoiceNumber) {
            if (confirm(`Are you sure you want to delete Invoice #${invoiceNumber}?`)) {
                let invoices = getInvoices();
                invoices = invoices.filter(inv => inv.invoiceNumber !== invoiceNumber);
                saveInvoices(invoices);
                populateInvoicesDashboard();
                clearForm(); // Clear the form if the current invoice was deleted
                alert('Invoice deleted successfully!');
            }
        }

        function clearForm() {
            document.getElementById('invoiceForm').reset();
            document.getElementById('billingTo').value = '';
            document.getElementById('siteAddress').value = '';
            document.getElementById('clientSelect').value = ''; // Reset client selection
            document.getElementById('invoiceNumber').readOnly = false; // Make invoice number editable for new invoice

            // Clear and re-add one default line item
            const lineItemsContainer = document.getElementById('lineItemsContainer');
            lineItemsContainer.innerHTML = '';
            addLineItem('', 1, 0); // Add a fresh, empty line item

            calculateGrandTotal(); // Reset totals
        }

        // --- PDF Download Functionality ---
        async function downloadPdf(invoiceNumberFromDashboard = null) {
            let invoiceToPrint = null;
            if (invoiceNumberFromDashboard) {
                const invoices = getInvoices();
                invoiceToPrint = invoices.find(inv => inv.invoiceNumber === invoiceNumberFromDashboard);
                if (!invoiceToPrint) {
                    alert('Invoice not found for PDF download.');
                    return;
                }
            } else {
                // If not from dashboard, use the current form's data
                const currentInvoiceNumber = document.getElementById('invoiceNumber').value.trim();
                if (!currentInvoiceNumber) {
                    alert('Please enter an invoice number before downloading the PDF.');
                    return;
                }
                const currentInvoices = getInvoices();
                invoiceToPrint = currentInvoices.find(inv => inv.invoiceNumber === currentInvoiceNumber);
                if (!invoiceToPrint) {
                    // If not saved, create a temporary invoice object from current form data
                     invoiceToPrint = {
                        invoiceNumber: currentInvoiceNumber,
                        invoiceDate: document.getElementById('invoiceDate').value,
                        dueDate: document.getElementById('dueDate').value,
                        client: {
                            name: document.getElementById('clientSelect').options[document.getElementById('clientSelect').selectedIndex]?.text || 'N/A',
                            billingAddress: document.getElementById('billingTo').value,
                            siteAddress: document.getElementById('siteAddress').value
                        },
                        lineItems: Array.from(document.querySelectorAll('.item-row')).map(row => ({
                            description: row.querySelector('.description').value.trim(),
                            quantity: parseFloat(row.querySelector('.quantity').value) || 0,
                            unitPrice: parseFloat(row.querySelector('.unit-price').value) || 0,
                            total: parseFloat(row.querySelector('.total-amount').textContent) || 0
                        })),
                        subtotal: parseFloat(document.getElementById('subtotal').textContent),
                        taxRate: parseFloat(document.getElementById('taxRate').value),
                        taxAmount: parseFloat(document.getElementById('taxAmount').textContent),
                        grandTotal: parseFloat(document.getElementById('grandTotal').textContent),
                        status: 'Unsaved'
                    };
                }
            }

            // Create a temporary, invisible div to render the invoice for PDF
            const tempPrintDiv = document.createElement('div');
            tempPrintDiv.style.position = 'absolute';
            tempPrintDiv.style.left = '-9999px';
            tempPrintDiv.style.top = '-9999px';
            tempPrintDiv.style.width = '794px'; // Approximate A4 width in pixels at 96 DPI for consistent rendering
            tempPrintDiv.style.padding = '30px';
            tempPrintDiv.style.backgroundColor = '#fff';
            tempPrintDiv.style.fontFamily = 'Arial, sans-serif';
            tempPrintDiv.style.fontSize = '12px';
            tempPrintDiv.style.lineHeight = '1.4';
            tempPrintDiv.style.color = '#333';

            // Construct the invoice HTML manually for better PDF fidelity
            let invoiceHtml = `
                <h1 style="text-align: center; color: #0056b3; margin-bottom: 20px;">Invoice #${invoiceToPrint.invoiceNumber}</h1>
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                    <div style="flex: 1;">
                        <p style="font-weight: bold; margin: 0;">BILLING TO:</p>
                        <pre style="white-space: pre-wrap; margin: 5px 0;">${invoiceToPrint.client.billingAddress}</pre>
                    </div>
                    <div style="flex: 1; text-align: right;">
                        <p style="font-weight: bold; margin: 0;">SITE ADDRESS:</p>
                        <pre style="white-space: pre-wrap; margin: 5px 0;">${invoiceToPrint.client.siteAddress || 'N/A'}</pre>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <div><span style="font-weight: bold;">Invoice Date:</span> ${invoiceToPrint.invoiceDate}</div>
                    <div><span style="font-weight: bold;">Due Date:</span> ${invoiceToPrint.dueDate || 'N/A'}</div>
                </div>

                <h3 style="color: #0056b3; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 15px;">Line Items</h3>
                <div style="display: flex; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 5px;">
                    <div style="flex: 3;">Description</div>
                    <div style="flex: 1; text-align: right;">Qty</div>
                    <div style="flex: 1; text-align: right;">Unit Price</div>
                    <div style="flex: 1; text-align: right;">Total</div>
                </div>
                <div style="margin-bottom: 20px;">
                    ${invoiceToPrint.lineItems.map(item => `
                        <div style="display: flex; padding: 5px 0; border-bottom: 1px dashed #eee;">
                            <div style="flex: 3; word-wrap: break-word; white-space: normal;">${item.description}</div>
                            <div style="flex: 1; text-align: right;">${item.quantity}</div>
                            <div style="flex: 1; text-align: right;">$${item.unitPrice.toFixed(2)}</div>
                            <div style="flex: 1; text-align: right; font-weight: bold;">$${item.total.toFixed(2)}</div>
                        </div>
                    `).join('')}
                </div>

                <div style="text-align: right; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                    <div style="margin-bottom: 8px;"><span style="font-weight: bold;">Subtotal:</span> $${invoiceToPrint.subtotal.toFixed(2)}</div>
                    <div style="margin-bottom: 8px;"><span style="font-weight: bold;">Tax Rate:</span> ${invoiceToPrint.taxRate}%</div>
                    <div style="margin-bottom: 8px;"><span style="font-weight: bold;">Tax Amount:</span> $${invoiceToPrint.taxAmount.toFixed(2)}</div>
                    <div style="font-size: 1.3em; font-weight: bold; color: #0056b3;"><span style="font-weight: bold;">Grand Total:</span> $${invoiceToPrint.grandTotal.toFixed(2)}</div>
                </div>
            `;
            tempPrintDiv.innerHTML = invoiceHtml;
            document.body.appendChild(tempPrintDiv);

            const { jsPDF } = window.jspdf;

            // Use html2canvas to render the temporary div as an image
            const canvas = await html2canvas(tempPrintDiv, {
                scale: 2, // Increase scale for better resolution
                useCORS: true,
            });

            // Remove the temporary div
            document.body.removeChild(tempPrintDiv);

            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgWidth = 210; // A4 width in mm
            const pageHeight = 297; // A4 height in mm
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            pdf.save(`Invoice_${invoiceToPrint.invoiceNumber}.pdf`);
        }

        // Function to print a specific invoice (from dashboard)
        function printSpecificInvoice(invoiceNumber) {
            const invoices = getInvoices();
            const invoice = invoices.find(inv => inv.invoiceNumber === invoiceNumber);

            if (!invoice) {
                alert('Invoice not found for printing.');
                return;
            }

            // Temporarily load invoice into form for printing
            const originalDisplay = document.getElementById('invoiceFormView').style.display;
            showInvoiceForm(invoiceNumber);

            // Use a timeout to ensure the DOM is updated before printing
            setTimeout(() => {
                window.print();
                // After printing, revert to dashboard view if it was originally there
                if (originalDisplay === 'block' || originalDisplay === '') { // If dashboard was visible
                     showDashboard();
                }
            }, 500); // Small delay
        }


        // --- Initialize on Load ---
        document.addEventListener('DOMContentLoaded', () => {
            populateClientSelect();
            showDashboard(); // Start on the dashboard view
            // Event listeners for calculating totals on input change
            document.getElementById('taxRate').addEventListener('input', calculateGrandTotal);
        });
    </script>
</body>
</html>
